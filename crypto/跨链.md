# 跨链技术

现在不止一条链，那么显而易见，我们需要某种让两条链产生关联的技术。

### 最基本的跨链：**信息跨链**

> 作者：maxdeath
> 链接：https://zhuanlan.zhihu.com/p/409846942
>
> 我们假设维护链A的这群人叫A星人，维护链B的人叫B星人，两者毫无交集。 
>
> 然后这个时候，A星的某个人去B星游玩，结果，一下宇宙飞船就被B星的海关拦住了—— 
>
> > “请出示你的身份。” 
> > “我可是A星大佬，我在A星的身份是xxxx，我在A星产业无数，资产上百亿，你竟然拦我？” 
> > 看到A星大佬摆架子，海关人员不为所动，冷冷说道： 
> > “是吗？你有证据吗？” 
> > A星大佬不屑地一笑： 
> > “当然，都在A链上，你可以自己去看。” 
> > “哦？我只认识B链，不认识什么A链。” 
> > 而这里，就需要用到跨链技术了，但很不幸的，A星大佬没有这项技术，而A链和B链也都没有采用跨链技术。 
> > 于是，跨链的第一个难题就来了—— 
> > “哼，你找个认识A星的人一问便知。” 
> > “不好意思，我不认识什么A星的人，如果你非要说自己是A星大佬，那么请出示证据。” 
> > 以上便是最基本的跨链——信息跨链。 
> > 而信息跨链的基本假设、问题和方法，也就隐含在两人的对话之中了—— 
> > 【假设】是：B星人愿意认同A星大佬在A星的地位，也就是愿意承认他在A链上的信息。 
> > 【问题】是：A星大佬要如何说服对方A链上真的有某些信息，比如他很有钱。 
> > 【方法】是：需要提供一个对方不需要去了解整个A链也能够验证的证据。 
> > A星大佬心想我在A星是什么人物，A链上的证据不是信手拈来？于是一个电话打给下属，说 
> > “把我在A链上身份和资产的证据打包一份发过来！我马上就要。” 
> > 下属收到了命令之后，立刻带着公司的技术团队召开了紧急会议，然后经过一个通宵，双目血红的程序员把证据交给了下属，而下属战战兢兢地把证据传给了A星大佬。 
> > A星大佬用100M带宽的缓慢的星际通讯网络里又足足下载了1天才下完全部证据，然后把证据交给了B星海关。 
> > B星海关人员看来证据之后说： 
> > “你这不就是整条A链么？我说了我没空验证这整条链。” 
> > A星大佬于是愤怒了，打开手机就把火全部发在了他的下属头上： 
> > “你是不是没有脑子？！我让你给我找我在A链上资产的证据？你把整条A链发过来了？” 
> > “呃……” 
> > 下属吞吞吐吐地回答， 
> > “技术团队找了很久也找不到这个‘证据’是什么，于是问了我们的科学顾问，而科学顾问说……由于A链用的是PoW算法，所以能够证明链上信息的证据……只有整条链……”

在区块链上世界中，**共识是概率的，没有最终性，因为没有绝对的最长的链来确认消息为真**

> 作者：maxdeath
> 链接：https://zhuanlan.zhihu.com/p/409846942
>
> A星大佬把手机交给B星海关，他手下的科学团队和海关的工作人员一通解释，B星海关表示十分理解，于是将“A星大佬在A链的h区块高度有信息m”这个信息发到了B链上，然后据此给A星大佬发了个9527的临时身份。 
> A星大佬长舒一口气，拿着临时身份和行李走了进去，可是才走了两步就又被拦下来了： 
> “抱歉，由于你的身份是临时的，请不要离开隔离区。” 
> “那这个身份多久才能变成正式的？” 
> “直到你把百分之百证明自己A链上的身份的证据给我们。” 
> “不是给你解释了吗？A链提供不了这样的证据。” 
> “呃……那就只能委屈你一直在隔离区呆着了。” 
> “好吧……那隔离区在哪？我在隔离区走走总行吧” 
> “隔离区就是这间屋子。” 
> A星大佬彻底崩溃了，但海关官员还在继续解释： 
> “因为我们放你出去，你用临时身份在B链上发了交易并且已经达成了共识，那么到时候如果你在A链上的信息更改了，那么B链上的就会出现不一致——有人看到A链上的h高度上没有信息m，于是就判定刚才我发的验证是假的，于是整条B链就会产生分叉。说白了——这个宇宙有许多星球，有许多链，我们无法判断每条链都用什么样的共识算法，也不知道哪条链有多安全。如果有个X星实际上已经被恶意节点控制了，那么即便给我整条X链，上面的东西依旧是可以篡改的。而如果我就根据这个认可了X星人的某个X链上的消息并将这个消息发上B链，相当于我把B链的安全性绑定在X链上了。这个时候，B链的确认就和X链一样不可靠，因为一旦X链分叉，篡改了被背书的消息，那么B链也就会产生分叉。”

实际上，这个问题和[DeFi的文章](https://zhuanlan.zhihu.com/p/377856331)中提过的“预言机”的问题是一样的。 

预言机的问题是：怎么样从链外获取正确和安全（不会出现给出不一致信息的情况）的信息，而我们的答案是——我们不知道，但是这不妨碍我们把这个我们不知道的问题抽象成一个叫做“预言机”的东西，把它放在外部世界和区块链之中，它可以对于链外的东西给出正确而又安全的信息并且签名认证，然后，我们在“预言机”存在的前提下继续做应用。而与此同时，我们再去思考怎么实现这么一个预言机。 

而现在跨链面临的问题是一样的——同样是从链外获取正确和安全的信息，只不过这次信息的来源变成了另一条区块链。

而想要让这个主体对于B链可信，实际上方法要灵活得多——比如经济抵押就是一个简便的方法。

> “您好先生，请证明您的身份。” 
> “这是整条A链，你看行不行。” 
> “您好，我们不接收这样的证据，不过没关系，您可以将证据提供给C公司，并且提交一笔费用，而C公司会负责审核您的证据然后向我们提交审核结果。” 
> “所以说你们可以认可C公司的审核结果？即便我提供的证据并不是百分之百安全？” 
> “我们认可C公司的声誉，同时，C公司在B链上有足够的资产和抵押，我们认为他不会提供错误的审核结果。而另一方面，如果他们认可了你的证据，那么就证明他们认为你提供的费用足以弥补可能的风险和造成的损失。” 
> “那么……假设，我是说假设，我来自不可靠的星球，或者我伪造了证据骗过了他们呢？你们会怎么处理？” 
> “我们只认他们给的结果。如果你骗过了他们，那么你的信息在B链上就是有效的，但是造成的损失，我们会去扣除C公司在链上的押金。”

C公司会怎么审核A星大佬的信息呢？其实很简单，它不用采用任何复杂的验证技术，也不需要A星大佬再提供什么额外的证据，他只要跑个A链的节点就好了——**跑个A链的节点**，他自然就能够知道A星大佬在A星上的身份，这个时候，A星大佬只需要提供证据证明自己的确是A链上的那位“A星大佬”就好了。

实际上，和负责提供链外信息的预言机一样，目前负责提供其他链信息的C公司其实多数也并没有提供抵押，但将这个服务转包出去的好处在于，我们现在倾向于认为——愿意提供这类服务的人由于自己的利益有诚实地并且一致地提供链外信息的意愿，自断财路的事大家都不会去做。而事实也确实如此，目前还没有看到提供预言机或者提供跨链服务的机构恶意攻击这个机制的情况。然而，有意愿不代表有能力，因为预言机和跨链导致的安全问题也一再出现，而这就是另一个故事了。



### 资产跨链：

> 作者：maxdeath
> 链接：https://zhuanlan.zhihu.com/p/409846942
>
> A星大佬终于办好了入境手续。
>
> 这个时候C公司提出了一个offer： 
> “你到B星得要钱吧？要不要使用我们的资产跨链服务？” 
> A星大佬一听来了兴趣： 
> “你先说说这个资产跨链是怎么回事？” 
> “简单说就是你在A链把你的钱打进某个地址，然后我们就在B链上我们把钱打给你。” 
> A星大佬一下就警惕了起来： 
> “等等，你是说，我得把钱先打给你？这听起来很危险啊，我怎么知道我把钱打给你了之后你会不会把钱给我？” 
> “哈哈，这个您不用担心，刚才我说的只是简洁的说法，具体来说是这样的……” 
> C公司的经理解释道： 
> “首先，我们会在A链上部署一个合约——这个合约要求你把钱打进一个地址，然后这笔钱会被锁住。同时，我们在B链上也部署一个合约，这笔合约的规则是：‘如果A链有笔钱在这个地址被锁住，而且把我们认证的签名信息发进这个合约，就把钱在B链上解锁’。而反之亦然，你也可以再把B链上的钱发给另一个锁定地址，然后用类似的方法拿回刚才你在A链上锁住的钱。” 
> “听起来很复杂……我怎么能知道给你的钱是真的被‘锁住’了，你没办法卷走呢？” 
> “以上的这些逻辑都写在智能合约里，你可以让技术人员或者第三方审查这些逻辑有没有漏洞或者后门之类的。” 
> “那跨链的过程中会不会出问题呢？比如我的钱锁住了，但是B链上的钱迟迟不解锁，这个时候汇率变了，我不就亏了吗？” 
> “你说的有道理，这的确是个麻烦事，所以，我们不直接把A链上的资产兑换成B链上的资产，而是在B链上创造A链上的镜像资产——也就是说，你在A链上锁定100A币，我不是根据汇率在B链上给你兑换B币，而是给你100叫做xA币的镜像资产……” 
> “等等……好像有哪里不对。” 
> A星大佬打断了C公司经理， 
> “所以你给我的不是B币而是你们自己发行xA币？你以为我是傻子很好骗吗？” 
> “不不您听我解释——首先，如果我们锁定和解锁合约的安全性100%可靠，你又能够相信我们会真实地提供跨链信息，那么xA和A其实就是等值的，因为任何人都可以把xA锁定之后去A链上解锁等值的A币，这点没错对吧。” 
> “好像没错。” 
> “那么如果B链上有一个自由的关于xA的市场，那么这个市场会怎么对xA定价呢？市场上的人肯定和您一样会去找专业人士审核我们的合约和机制，如果他们对安全有信心，那么xA的定价就会和A基本一致。所以说，您其实并不需要知道xA究竟有什么用，或者是不是安全，只需要知道在B链的市场上，xA可以和A等价交换就可以了，这其实也说明了市场认为我们的机制是安全的。” 
> “这么说也有道理。”A星大佬继续问， 
> “那么B链上有这种开放的市场吗？” 
> “有的，这就是DEX了。也就是说，您也不需要担心汇率的问题，这个市场的汇率会和链外的市场保持一致（详见[maxdeath：DeFi是什么？（上）](https://zhuanlan.zhihu.com/p/377856331)）。因此，我们只要帮你完成了A币和xA币之间的兑换，你可以自行选择汇率合适的情况换成B币。”

作者：maxdeath
链接：https://zhuanlan.zhihu.com/p/409846942
来源：知乎
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。



以上，就是资产跨链的基本原理。 

正如A星大佬纠结的一样，资产跨链的问题也就是这几个—— 

1，**锁定机制**：在两条链上各部署一个（或几个）智能合约，使得一条链上的锁定币的信息可以作为钥匙，解锁另一条链上的币，反之亦然。这点，是跨链技术的核心，但实际上如果两条链都像是以太坊这样“图灵完备”的区块链的话，其实实现起来并不困难。但另一方面，如果其中一条链是如同比特币这样的功能有限的链，如何实现这件事就需要花上很多功夫。 

2，**消息跨链机制**：大家最初担心的事情和前面一样，就是如何保证跨链证据的安全性——尤其是如果有人提供了一个证据说A币锁定了，然后拿A币换成了B币，但接着A币锁定的消息没了（由于共识的安全性），那么如果B链不回滚这笔交易，则相当于B币凭空增发了，这对于B币的经济模型是很大的打击。但和之前的消息跨链一样，通过把跨链外包给第三方，我们也可以规避掉这个问题。 

3，**汇率**：接下来的问题就是A星大佬担心的了——如果是希望把A币直接跨链过来变成B币，那么跨链的过程中汇率变了怎么办？从现在的方案看起来，这事有些不可理喻。但最初，人们对于资产跨链的方案是：在A链上锁定A币——>在B链上释放B币。而这里，除了涉及到需要从预言机读取汇率的问题，最令人头疼的就是区块链对于交易上链的时间没有保证这件事了—— 

由于区块链对于交易上链的时间其实是没有保证的，而且是币价越波动交易越容易堵塞。于是，虽然说从技术上通过哈希锁定+消息跨链来实现“在A链上锁定A币——>在B链上释放B币”是可行的，但是从实际当中完全行不通，因为这个过程时间是不定的。于是，比如现在A币可以换10个B币，然后你发起来跨链，结果B币暴涨，而因此B链出现了堵塞，直到过了4个小时，A币只能换5个B币了。这个时候你肯定想的是：我不换了，把A币还给我。然而，跨链的这个过程是无法中途撤销的，于是，你只能眼睁睁地看着你的钱包缩水了一半。这样的资产跨链技术显然是不能令人满意的。 

这个问题其实困扰了大家很久，直到DEX和类似于wBTC这种货币的出现这个问题才迎刃而解。方法其实和我们在DEX里介绍wBTC的原理是一致的——就是不直接兑换，而是在另一条链上发行这个币种的复制。这一来前面的问题也迎刃而解——即便是A币的锁定交易出了问题，也只是导致复制出来的xA币价下跌，而不会影响到B的币价。至于汇率的问题，之前主要的担心是跨链这个过程的时间无法保证，因此担心这个过程中的币价波动。而现在如果A和xA是一比一兑换的，那么跨链的速度问题就没那么值得担心了。 

有人可能会觉得——这个法子看起来很简单啊，为什么之前没人想到呢？很简单，因为之前DEX还不普及，你把A币跨成xA币并不是真的资产跨链。但现在，如果B链上有能够把xA和B币进行兑换的DEX，那么这种方案很显然是目前看来最合逻辑的跨链方案。 

### 跨链的四种方法：

#### 一、基于哈希时间锁的 资产互换

基本原理是这样的：

> 比如A星大佬某天开会的时候和某位B星大佬说好了，用一个A币换10个B币。
>
> A星大佬先随便选一个数x，然后做哈希，算出H(x)。这样，他可以把H(x)作为谜题，而x作为谜底。 
>
> 然后，A星大佬在A链上发了一笔交易给B星大佬提供的收款地址，但是这笔交易设置了一个谜题H(x)，要求收款时提供x。当然，为了防止B星大佬反悔，这笔交易将在某个时间之后失效，失效之后钱会原路退还给A星大佬。 
>
> 当B星大佬看到这笔交易，并且相信这笔交易已经确认，就在B链上也发一笔交易给A星大佬提供的收款地址，同样用H(x)设置了谜题，需要A星大佬提供x才能完成交易。 
>
> 这样，如果A星大佬看到这笔交易并且相信这笔交易已经确认，如果他想要10个B币，那么他就得提供x。而如果他提供了x之后，B星大佬就能够拿到属于自己的1个A币。 

从原理上，这种资产跨链方案十分精巧——它甚至不需要依赖于信息跨链，整个过程中，没有任何信息被从A链上跨到了B链上。这是怎么实现的呢？实际上仰赖了双方的理性——B星大佬在不能确信A星大佬的交易已经在A链确认之前，是不会提交自己的交易的；而另一方面，A星大佬在不能确信B星大佬的交易已经在B链确认之前，也是不会公开x的。而当双方都确认并且公开x之后，交易就自动完成了。 

这种方案巧妙地规避了“信息跨链”这件最麻烦的事情——**双方都不需要说服对方的链上的共识节点“自己的某笔交易已经确认”**，因为双方其实只要让彼此相信就够了。而因为涉及到自己的利益，双方也自然会尽最大的能力去验证，即便它们验证出了问题，也最多只是造成自己的财产损失——而这个风险是它们自担的。 

这个方案其实从原理上类似比特币的闪电网络，也正是因此，闪电网络的所有问题它也有： 

1，它**不是个通用方案**，仅限于双方有自身利益的资产跨链，而做其他用途的时候就可能需要更复杂的机制，甚至无法实现。 

2，乍看上去，理性的双方在这个交易中是各取所需的；但实际上，主动发起交易的一方，也就是A星大佬，是吃亏的一方——因为如果在交易过程中币价发生波动，那么如果B币价格涨了，B完全可以不进行交易。也就是说，当A星大佬把交易上链了，B星大佬就可以一直观望——如果价格涨了就不交易，跌了再发布交易。而这个时候A只能吃哑巴亏，因为他的钱已经被锁定在交易里了——如果交易不进行，A星大佬的钱得要等很长一段时间才会退回来。因此，B币价格就算是涨了，可能A也之后按照约定价格卖掉。 

而因为有了这个问题，实际上B星大佬要是理性的话，他最优的策略就是观望，等到价格对自己有利的时候再完成交易，否则就退出交易。于是导致的结果就是——一方面A想要买B币需要出高价，这点可能还能接受；但另一方面，如果B币一直上涨的话，A甚至在交易之初没法确认能否顺利成交。 

因此，**一方面，这种方案精巧地构筑在了“节点的理性”之上；但另一方面，这种理性又反过来导致了这种方案几乎不现实**，尤其是，当我们有了可替代跨链方案的时候，这份基于哈希锁的资产互换方案，就立刻被弃置一旁了。

#### 二、验证者 跨链

第二个方案，就是验证者跨链，这次换做下属来给A星大佬讲。 

> “验证者跨链基本上和你遇到的C公司的方案类似——我们找个可信的节点，比如我们自己，作为验证者。这个验证人的工作很简单，他就正常地跑两条链的客户端就行了。然后，当A链上有跨链消息的时候，他负责在这条消息在A链上确认了之后，对这个消息签名，然后转发到B链完成消息跨链。当然，如果是资产跨链的话，那么这个消息就代表A链上资产被锁定，而转发的消息就可以在B链上解锁同样数量的镜像资产。” 
> “这我都知道了，那咱们的方案能不能做点改进呢？” 
> “我们可以采用‘门限签名’的方案——就是相比于C公司，我们可以在我们公司之外，在拉来几个大公司，比如H公司和Z银行，然后，让他们也来做验证者。然后，在跨链的时候，跨链信息需要携带的不是1个签名，也不是3个签名，而是一个3选2的门限签名——也就是说，这个签名需要三个人中至少两个人认可才有效。这样的话，即避免了单点故障的情况，又增加了这个签名的可靠性。” 

验证者跨链，也就是C公司采用的方法，实际上是当下大多数跨链方案使用的方法。一个很现实的原因是——因为目前大部分跨链的需求都是发生在某条（类以太坊）公链和以太坊之间的，而对于跨链节点而言，额外运行个以太坊客户端是非常容易也是最简单易行的方法。而这些跨链方案，或者叫跨链桥之中，很多都采用了上述的门限签名的方案——也就是跨链信息的真实性，由几个权威机构中的多数担保，这样可靠性显然强过由单个机构担保。

#### 三，中继者 跨链

中继者（relayer）跨链的逻辑是——中继者不负责对于跨链信息提供背书，而仅仅负责将跨链的证据转发到另一条链上。 

实际上，这就类似A星大佬第一次失败的跨链尝试的方案。而正如A星大佬吃瘪的原因，中继链跨链并不适用于所有的区块链，比如A星大佬所处的采用PoW共识的A链，由于共识不具备最终性，因此无法提供一个跨链消息在链上确认的证明，于是就不能采用中继者跨链。 

但是，如果两条链都采用BFT类算法，有最终性，能够提供一个跨链消息的真实性证明，那么中继者需要做的事就是在收集到这个证明之后，把它和跨链交易一起“中继”到另一条链上。可见，相比于验证者，中继者的工作相当轻松，甚至于不需要运行两条链的客户端，只不过是负责传递一下消息就好了。而按照这个思路延伸一下，其实中继者跨链甚至不需要某个特定的“中继者”，只需要一个通信协议——比如说，所有有最终性的区块链都将跨链消息和证据按固定的格式打包成一个链间通信信息，然后所有的区块链节点看到这个信息就会帮忙把这个信息转到它该去的链上去。也就是说，只要认可这个协议的人，其实都是中继者。而Cosmos提出的IBC协议就是这样一个方案，但目前，首先主流的公链，尤其是以太坊，都还没有最终性。因此，IBC协议，以及中继者跨链，实际上能够使用的场景并不多。

#### 四，“跨链”链 

> “你们眼界都太窄了。” 
> A星大佬对前两份方案很不满意， 
> “我们要做的可不是一个跨链方案，我们要打通区块链生态闭环和信息屏障，以跨链为抓手，聚焦区块链使用者的真实需求，为区块链使用者赋能，创造新的引爆点……” 
> “那么……我建议您详细了解下第四份方案。” 

于是，A星大佬翻开了“跨链”链的方案，或者这上面有个霸气的名字——万链互联方案。 

这个方案实际上就是验证者方案+聚合签名的扩展—— 

1. 我们不仅考虑两条链的跨链，我们考虑很多条链的跨链。 
2. 我们不仅找3个验证者，我们找一堆验证者。 
3. 我们不仅用k选n的聚合签名，我们干脆用区块链——区块链共识算法不就保证区块链上所有消息都通过大多数验证者的验证了吗？ 

于是，这个方案就呼之欲出了——做一条新的区块链，这条链的共识节点都是可靠的验证者，而它们负责验证很多链上的跨链消息，并且负责发到链上。于是，这条链就成了一个可靠的“跨链信息来源”，而所有的链不需要额外的验证者跨链方案，也不需要和所有想跨的链各建一条跨链桥，而都只需要从这条链上获取信息就好了。 

A星大佬看完这个提案眼里发光，当即拍板：“就它了！” 

而事实上，这样的跨链方案，比如Wanchain，比如IRIS，都是非常受追捧的项目。 

**其他技术细节** 

除了四个方案的区别之外，各种跨链方案在实现方面有一些类似于各个rollup方案之间的差别——比如每条跨链消息都单独“跨”，还是几条跨链消息打包在一起“跨”，又或者定期“跨”这段时间内所有的跨链消息，并且单独开一个合约记录另一条链的当前状态。这几种方案，基本上就是在效率（每笔跨链的消息复杂度）和延迟（跨链交易的确认时间）上做取舍。 

此外，另一个各个跨链方案间的不同之处在于——跨链的信息，究竟是谁负责发给目标链。继续沿用之前的例子的话，就是A星大佬获得了C公司的认证之后，这个认证结果是C公司负责发给B链的海关，还是发给A星大佬让他自己交给B链海关。这个差别看似无关紧要，但在实际之中是非常关键的。这还是因为区块链不保证消息上链的时间的问题，以及网络堵塞时交易费的问题。第一个方案看似用户体验更好，但如果C公司认证通过之后B链正好堵塞，那么如果C公司仍旧按照之前的交易费来提交跨链证据，那么就可能出现长时间无法上链的情况，而这对于有时间需求的用户是无法接受的。但另一方面，如果C公司收用户更高的服务费来保证上链时间，那么一方面不急用的用户并没有这种需求，另一方面如果遇到极端情况交易费涨上天，C公司还是需要冒风险。因此，其实看似用户体验不好，但是实际上最合逻辑的方法，还是C公司只负责验证，然后把证据和负责上链的责任发回给用户，让用户根据自己的需求，决定愿意花多少交易费上链。 

**跨链与侧链的区别** 

在文中我们多次类比了跨链和二层网络方案，比如闪电网络和Rollup。那么跨链和侧链的区别在哪呢？实际上，两者在很多地方都有相似性，但核心逻辑上——**跨链中两条链的地位是平等的而侧链不是**。跨链中双方链的节点都默认不知道对方的链，因此信息互通需要能够验证对方链上的真实性，或者由同时运行两条链的节点背书，而这里，背书节点理论上需要在两条链上都有经济抵押。而侧链中，所有侧链的节点默认是同时运行主链的。所以，验证信息是单方面的——只有侧链的信息提交到主链上需要验证，而经济抵押也只需要在主链上即可。 

而以上的这种差别，也可以用来从逻辑上区分跨链和侧链。如果某个跨链方法只有单向信息通信，或者单向抵押，那么实际上这就是一个侧链方案而非跨链方案