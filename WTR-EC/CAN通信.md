# CAN协议通信

## 0   基础

### 0.1   发展史

CAN是**控制器局域网络**(Controller Area Network, CAN)的简称，是一种能够实现分布式实时控制的串行通信网络。

CAN的发展历史节点：

- _**1983**_年，BOSCH开始着手开发CAN总线；
- ***1986***年，在SAE会议上，CAN总线正式发布；
- ***1987***年，Intel和Philips推出第一款CAN控制器芯片；
- _**1991**_年，奔驰 500E 是世界上第一款基于CAN总线系统的量产车型；
- _**1991**_年，Bosch发布CAN 2.0标准，分 ***CAN 2.0A\*** （11位标识符）和 ***CAN 2.0B\*** （29位标识符）；
- _**1993**_年，ISO发布CAN总线标准（***ISO 11898\***），随后该标准主要有三部分：
- ISO 11898-1：数据链路层协议
- ISO 11898-2：高速CAN总线物理层协议，通信速度为 125kbps-1Mbps。
- ISO 11898-3：（整合了ISO11519）低速CAN总线物理层协议，通信速度为 125kbps 以下。
- _**2011**_年，开始CAN FD协议的开发。
- _**2015**_年ISO11898-1进行了修订，将**CAN FD**加入其中。

我们平常接触的一般是 CAN 2.0  高速闭环CAN（加了终端电阻）



![image-20240218105753888](CAN通信.assets/image-20240218105753888.png)

![image-20240218105823920](CAN通信.assets/image-20240218105823920.png)

> ### 这个1M 是由仲裁速率决定的



### 0.2   CAN的物理通信形式

通过两条通信线（双绞线）产生的电压差传输数据，一个CAN网络里的所有节点都挂在这两条通信线上，使用差分信号半双工通信。

![在这里插入图片描述](CAN通信.assets/5e7ce65f1bff40e49c79f432119f3053.png)

但是如果线的传输距离短，其实**没有双绞也不太影响功能实现**。



## 1   通信

### 1.1   拓扑结构

![image-20240218104236501](CAN通信.assets/image-20240218104236501.png)



### 1.2   信号电平

在CAN总线上，利用 `CAN_L` 和 `CAN_H`  两根线上的电位差来表示CAN信号。

电位差分为：

* **显性电平**  ---------------- 逻辑   **0**
* **隐形电平**  ---------------- 逻辑   **1**



> “显性”具有“优先”的意味，只要有一个单元输出显性电平，总线上即为显性电平。
>
> “隐 性”具有“包容”的意味，只有所有的单元都输出隐性电平，总线上才为隐性电平。（显性电平比 隐性电平更强。）



低速 物理层电平（不重要）：

<img src="CAN通信.assets/v2-3667818bfa85894c20ee09fb428f363d_720w.webp" alt="img" style="zoom:50%;" />



CAN2.0  高速 物理层电平：

![img](CAN通信.assets/v2-aabdb0a85b5bc7446840ed2b8c4d788e_720w.webp)



### 1.3   传输过程

![image-20240218105332111](CAN通信.assets/image-20240218105332111.png)



### 1.4   CAN通信特点

#### 1.4.1   多主工作模式

​	多主控制 在总线空闲时，所有的单元都可开始发送消息（多主控制）。 **最先访问总线的单元**可获得发送权（CSMA/CA 方式*1）。 多个单元同时开始发送时，发送高优先级 ID 消息的单元可获得发送权。

#### 1.4.2    非破坏仲裁机制

​	在 CAN 协议中，所有的消息都以固定的格式发送。**总线空闲**时，所有与总线相连的单元都可以开始发送新消息。



> 在CAN协议中，当总线上的上出现连续的11位隐性电平（两根线电压差小于0.5V），表示总线就处于空闲状态。



两个以上的单元同时开始发送消息时，根据**标识符**（Identifier 以下称为 ID）决定优先级。

> ID 并不是表示发送的目的地址，而是表示访问总线的消息的优先级。两个以上的单元同时开始发送消息时，对各消 息 ID 的每个位进行逐个仲裁比较。仲裁获胜（被判定为优先级最高）的单元可继续发送消息，仲裁失利的 单元则立刻停止发送而进行接收工作。

#### 1.4.3    系统的柔软性

与总线相连的单元没有类似于“地址”的信息。因此在总线上增加单元时，连接在总线上的其它单元的软硬 件及应用层都不需要改变。

#### 1.4.4    通信速度

 根据整个网络的规模，可设定适合的通信速度。 在同一网络中，所有单元必须设定成统一的通信速度。即使有一个单元的通信速度与其它的不一样，此单元 也会输出错误信号，妨碍整个网络的通信。不同网络间则可以有不同的通信速度。

#### 1.4.5    远程数据请求

可通过发送“遥控帧” 请求其他单元发送数据。

#### 1.4.6     错误检测功能·错误通知功能·错误恢复功能

所有的单元都可以检测错误（错误检测功能）。 检测出错误的单元会立即同时通知其他所有单元（错误通知功能）。 正在发送消息的单元一旦检测出错误，会强制结束当前的发送。强制结束发送的单元会不断反复地重新发送 此消息直到成功发送为止（错误恢复功能）

#### 1.4.7    连接 CAN 总线

是可同时连接多个单元的总线。可连接的单元总数理论上是没有限制的。但实际上可连接的单元 数受总线上的时间延迟及电气负载的限制。降低通信速度，可连接的单元数增加；提高通信速度，则可连接 的单元数减少







## 2    CAN协议



通信是通过以下 5 种类型的帧进行的。

* 数据帧 
* 遥控帧 
*  错误帧
*  过载帧 
*  帧间隔

> 另外，数据帧和遥控帧有标准格式和扩展格式两种格式。
>
> 标准格式有 **11 个位的标识符**（Identifier: 以下称 ID）， 扩展格式有 **29 个位的 ID**。



![image-20240218111719655](CAN通信.assets/image-20240218111719655.png)



### 2.1   遥控帧与数据帧

![image-20240218111829121](CAN通信.assets/image-20240218111829121.png)

![image-20240218112055427](CAN通信.assets/image-20240218112055427.png)

![image-20240218111904319](CAN通信.assets/image-20240218111904319.png)



CAN里定义的遥控帧实际作用不大，而且可以用数据帧配合应用协议的定义，进行替代。所以在后来的CAN-FD中已经取消了遥控帧的定义了。



数据帧由 7 个段构成：

| 帧起始 | 表示数据帧开始的段                   |
| ------ | ------------------------------------ |
| 仲裁段 | 表示该帧优先级的段。                 |
| 控制段 | 表示数据的字节数及保留位的段         |
| 数据段 | 数据的内容，可发送 0～8 个字节的数据 |
| CRC 段 | 检查帧的传输错误的段                 |
| ACK 段 | 表示确认正常接收的段。               |
| 帧结束 | 表示数据帧结束的段。                 |



#### 2.1.1  帧起始

表示帧开始：***1 个位的显性位***  即 逻辑 0



#### 2.1.2   仲裁段

![image-20240218112903287](CAN通信.assets/image-20240218112903287.png)

**D为显性**

#### 仲裁过程

> 回读机制：节点在向总线发送报文的过程中，同时也对总线上二进制位进行  “回读”
>
> 线与机制：指在总线上，**显性位能够覆盖隐性位**

例子：总线空闲时，A  B 节点同时向总线上发送数据：

![image-20240218135737481](CAN通信.assets/image-20240218135737481.png)

在 ID7 的时候，Node_B  发现自己和总线上的电平不一致，Node_B 在总线仲裁中失败，主动转变为接收状态。

因为在仲裁过程中，并不会影响最终线权获得人Node_A 的信息，故称之为 **非破坏性仲裁机制**

> ### RTR位：
>
> **远程发送请求位**，数据帧中 RTR 恒为**显性位0**，遥控帧中恒为**隐性位1**---------- 保证在ID号相同的情况下，数据帧优先级高于遥控帧。
>
> ### SRR位：
>
> **替代远程请求位**，在扩展帧中，SRR恒为**隐性位1**，保证标准数据帧的优先级高于扩展数据帧。
>
> ### IDE位：
>
> 扩展帧中恒为隐性1， 标准帧中恒为显性，保证  标准遥控帧 的优先级高于扩展摇控帧。



#### 报文过滤

CAN通信中没有   **地址**  概念，而是通过 **报文ID** 实现收发，每个CAN节点中都会有一个  **验收滤波ID表**，例如：某个节点A发送了 ID_1  的报文，如果 节点B中的  **验收滤波ID表** 中含有 ID_1 节点B将会接收这一帧报文。



#### 2.1.3    控制段

作用：告诉接收者 原始数据大小，以便于对比接收到的大小。

![image-20240218113131029](CAN通信.assets/image-20240218113131029.png)

![image-20240218113252750](CAN通信.assets/image-20240218113252750.png)

#### 2.1.4   数据段

![image-20240218113340582](CAN通信.assets/image-20240218113340582.png)

#### 2.1.5    CRC段

![image-20240218113423357](CAN通信.assets/image-20240218113423357.png)

![image-20240218150012290](CAN通信.assets/image-20240218150012290.png)

#### 2.1.6    ACK段

![image-20240218113515262](CAN通信.assets/image-20240218113515262.png)



> 发送 ACK 的是在既不处于总线关闭态也不处于休眠态的所有接收单元中，接收到正常消息的单元 （发送单元不发送 ACK）。所谓正常消息是指不含填充错误、格式错误、CRC 错误的消息。

![image-20240218143555136](CAN通信.assets/image-20240218143555136.png)

#### 2.1.7   帧结束

![image-20240218113656196](CAN通信.assets/image-20240218113656196.png)





### 2.2    错误帧

用于在接收和发送消息时检测出错误，通知错误的帧。错误帧由**错误标志**和**错误界定符**构成。

#### 2.2.1   错误标志

 错误标志包括主动错误标志和被动错误标志两种。 

* 主动错误标志：6 个位的显性位。 
* 被动错误标志：6 个位的隐性位。

####  2.2.2   错误界定符 

错误界定符由 8 个位的隐性位构成

![image-20240218144724671](CAN通信.assets/image-20240218144724671.png)



#### 2.2.3   错误检测：

> 前置知识：
>
> CAN协议中规定，**当相同极性电平持续5位的时候，添加一个极性相反的位**---------为防止突发错误而设定的功能。
>
> ![image-20240218145111190](CAN通信.assets/image-20240218145111190.png)
>
> (1) 发送单元的工作 在发送数据帧和遥控帧时，SOF～CRC 段间的数据，相同电平如果持续 5 位，在下一个位（第 6 个位）则 要插入 1 位与前 5 位反型的电平。 
>
> (2) 接收单元的工作 在接收数据帧和遥控帧时，SOF～CRC 段间的数据，相同电平如果持续 5 位，需要删除下一个位（第 6 个 位）再接收。如果这个第 6 个位的电平与前 5 位相同，将被视为错误并发送错误帧

![image-20240218145721520](CAN通信.assets/image-20240218145721520.png)



#### 2.3.4    错误通知

检测到错误的节点要发送错误帧到总线上通知其他节点。

#### 节点错误状态：

* 主动错误
* 被动错误
* 总关闭   ----- 该状态不能正常收发**报文**

这些状态可以转换

> 在CAN节点中有：
>
> **发送错误计数器（TEC）**
>
> **接受错误计数器（REC）**
>
> ![image-20240218150706291](CAN通信.assets/image-20240218150706291.png)

![image-20240218150725025](CAN通信.assets/image-20240218150725025.png)



主动错误标志是   **连续6个显性位**   这将覆盖掉总线上其他节点发送，因为它无法判断是自己的问题还是别的节点的问题，总之提醒总线上所有节点。

被动错误标志是   **连续6个隐性位**  这将不会影响其他节点发送，因为它觉得是自己的问题，主动默默退出仲裁。

>  当 $TEC >255 $ 时，总线处于关闭状态，节点脱离总线。等检测到128次11连续隐性位将会回到主动错误状态，TEC与REC 置零。



#### 错误帧的输出 ：

检测出满足错误条件的单元输出错误标志通报错误。 处于主动错误状态的单元输出的错误标志为主动错误标志；

处于被动错误状态的单元输出的错误标志为被动 错误标志。 发送单元发送完错误帧后，将再次发送数据帧或遥控帧。 错误标志输出时序如表 ：

![image-20240218151750731](CAN通信.assets/image-20240218151750731.png)

![image-20240218151844129](CAN通信.assets/image-20240218151844129.png)

![image-20240218151902904](CAN通信.assets/image-20240218151902904.png)

![image-20240218151913622](CAN通信.assets/image-20240218151913622.png)



### 2.3   过载帧

接收节点报告自身接受能力到达极限的帧，通知自己尚未完成接受准备。

由：

* 6位   过载标志       构成与主动错误标志的构成相同
* 8位   过载界定符   构成与错误界定符的构成相同

构成。

![image-20240218152127541](CAN通信.assets/image-20240218152127541.png)**
